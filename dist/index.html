<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OilPulse | 醫師專業版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@200;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Serif TC', serif; background-color: #F8F7F3; }
        .bento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        @media (max-width: 640px) { .bento-grid { grid-template-columns: repeat(2, 1fr); } }
        .prescription-card {
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(180deg, #FEFEFC 0%, #FAF9F5 100%);
            border: 1px solid #D4C4A8;
            box-shadow: 0 4px 24px rgba(26, 67, 78, 0.06), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .prescription-card .sig-line { border-bottom: 1px solid #1A434E; width: 8em; display: inline-block; vertical-align: bottom; margin-left: 0.5rem; }
        .prescription-card .letterhead { letter-spacing: 0.35em; color: #1A434E; }
        .pdf-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="p-6 text-[#1A202C]">
    <header class="max-w-xl mx-auto text-center py-12">
        <h1 class="text-4xl font-extralight tracking-[0.4em] text-[#1A434E]">OILPULSE</h1>
        <div class="h-px bg-[#1A434E]/20 w-16 mx-auto mt-6"></div>
        <p class="mt-4 text-[9px] uppercase tracking-[0.5em] text-stone-400">Genesis 2.6 Sovereign Analytics</p>
    </header>

    <main class="max-w-xl mx-auto">
        <div class="bento-grid" id="states-grid"></div>

        <div id="results-area" class="mt-16 space-y-6"></div>

        <div id="prescription-container" class="mt-12 hidden"></div>

        <footer class="mt-24 border-t border-stone-200 pt-8 text-[10px] text-stone-300 text-center leading-loose tracking-widest">
            高堯楷醫師監製 · 創世架構 2.6<br/>
            * 僅供芳療教育參考，不作為醫療診斷依據 *
        </footer>
    </main>

    <script>
        (function () {
            'use strict';

            var STATES = ["焦慮不安","睡不好","疲倦無力","頭部緊繃","肌肉痠痛","消化不適","注意力渙散","情緒低落","壓力大","呼吸不順","肌膚困擾","想放鬆"];
            var CONFIG = {
                org_id: getOrgId(),
                pulseMatchUrl: 'https://us-central1-oilpluse-cb370.cloudfunctions.net/getPulseMatch',
                exportPdfUrl: 'https://us-central1-oilpluse-cb370.cloudfunctions.net/exportPrescriptionToPdf'
            };

            function getOrgId() {
                try {
                    var key = 'oilpulse_org_id';
                    var stored = sessionStorage.getItem(key);
                    if (stored) return stored;
                    var defaultOrg = 'default_org';
                    sessionStorage.setItem(key, defaultOrg);
                    return defaultOrg;
                } catch (e) {
                    return 'default_org';
                }
            }

            function generateIdempotencyKey() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            var grid = document.getElementById('states-grid');
            var resultsArea = document.getElementById('results-area');
            var prescriptionContainer = document.getElementById('prescription-container');

            STATES.forEach(function (s) {
                var btn = document.createElement('button');
                btn.className = 'p-6 text-sm rounded-[2.5rem] border border-stone-100 bg-white hover:border-teal-200 transition-all duration-700 shadow-sm text-stone-500 font-light';
                btn.innerText = s;
                btn.onclick = function () { callPulseEngine(s, btn); };
                grid.appendChild(btn);
            });

            function callPulseEngine(state, el) {
                document.querySelectorAll('#states-grid button').forEach(function (b) {
                    b.classList.remove('bg-[#1A434E]', 'text-white', 'shadow-2xl', 'scale-95');
                    b.classList.add('bg-white', 'text-stone-500');
                });
                el.classList.add('bg-[#1A434E]', 'text-white', 'shadow-2xl', 'scale-95');
                el.classList.remove('bg-white', 'text-stone-500');

                resultsArea.innerHTML = '<div class="text-center py-20"><div class="animate-spin inline-block w-6 h-6 border-2 border-teal-600 border-t-transparent rounded-full mb-4"></div><p class="text-stone-300 italic font-light tracking-widest text-sm">正在調用雲端脈動引擎...</p></div>';
                prescriptionContainer.classList.add('hidden');
                prescriptionContainer.innerHTML = '';

                var idempotencyKey = generateIdempotencyKey();
                var requestPayload = { data: { state: state, org_id: CONFIG.org_id } };

                fetch(CONFIG.pulseMatchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                })
                    .then(function (response) { return response.json(); })
                    .then(function (responseData) {
                        var oils = responseData.result && responseData.result.data ? responseData.result.data : [];
                        renderOils(oils, state);
                        renderPrescriptionCard(oils, state, idempotencyKey);
                    })
                    .catch(function () {
                        resultsArea.innerHTML = '<p class="text-center text-red-300 font-light">連線中斷，請確認網路狀態</p>';
                    });
            }

            function renderOils(oils, state) {
                resultsArea.innerHTML = oils.map(function (oil) {
                    return '<div class="bg-white p-8 rounded-[3rem] border border-stone-50 shadow-sm hover:shadow-xl transition-all duration-500 group">' +
                        '<div class="flex justify-between items-start">' +
                        '<div><span class="text-[9px] text-teal-600 font-bold uppercase tracking-[0.2em]">Matched Essence</span>' +
                        '<h3 class="text-3xl font-light text-[#1A434E] mt-2">' + escapeHtml(oil.zh_name) + '</h3>' +
                        '<p class="mt-4 text-sm text-stone-400 font-light leading-relaxed">針對「' + escapeHtml(state) + '」狀態，此植物頻率具備極佳的調和作用，建議於早晚脈動處嗅聞。</p></div>' +
                        '<div class="text-right"><span class="bg-stone-50 text-stone-400 text-[9px] px-3 py-1 rounded-full border border-stone-100 italic">藥性：' + escapeHtml(oil.nature || '—') + '</span></div></div></div>';
                }).join('');
            }

            function escapeHtml(text) {
                if (text == null) return '';
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatDate() {
                var d = new Date();
                var y = d.getFullYear();
                var m = String(d.getMonth() + 1).padStart(2, '0');
                var day = String(d.getDate()).padStart(2, '0');
                return y + ' 年 ' + m + ' 月 ' + day + ' 日';
            }

            function renderPrescriptionCard(oils, state, idempotencyKey) {
                if (!oils || oils.length === 0) return;

                var oilList = oils.map(function (o) { return o.zh_name + '（' + (o.nature || '—') + '）'; }).join('、');
                var dateStr = formatDate();

                var card = document.createElement('div');
                card.id = 'prescription-card';
                card.className = 'prescription-card rounded-[2rem] p-10 md:p-12';
                card.setAttribute('data-idempotency-key', idempotencyKey);
                card.setAttribute('data-state', state);
                card.setAttribute('data-org-id', CONFIG.org_id);

                card.innerHTML =
                    '<div class="letterhead text-center text-xs font-semibold tracking-[0.4em] mb-8">芳療建議處方箋</div>' +
                    '<div class="text-[#1A434E] text-sm leading-loose space-y-4">' +
                    '<p><span class="text-stone-500">就診狀態</span> ' + escapeHtml(state) + '</p>' +
                    '<p><span class="text-stone-500">建議精油</span> ' + escapeHtml(oilList) + '</p>' +
                    '<p><span class="text-stone-500">使用方式</span> 早晚於脈動處輕嗅，每次約 1～2 分鐘；僅供芳療教育參考，不取代醫療建議。</p>' +
                    '<p class="text-stone-400 text-xs mt-6">處方日期 ' + dateStr + '</p>' +
                    '</div>' +
                    '<div class="mt-10 pt-8 border-t border-stone-200/80 flex justify-end">' +
                    '<div class="text-right">' +
                    '<span class="text-[#1A434E] font-semibold text-sm">高堯楷</span><span class="prescription-card sig-line"></span>' +
                    '<p class="text-[10px] text-stone-400 mt-1 tracking-widest">醫師</p>' +
                    '</div></div>' +
                    '<div class="mt-8 flex justify-end gap-3">' +
                    '<button type="button" id="btn-export-pdf" class="pdf-btn px-5 py-2.5 rounded-full border border-[#1A434E] text-[#1A434E] text-sm font-medium hover:bg-[#1A434E] hover:text-white transition-all duration-300">導出 PDF</button>' +
                    '</div>';

                prescriptionContainer.appendChild(card);
                prescriptionContainer.classList.remove('hidden');

                document.getElementById('btn-export-pdf').onclick = function () {
                    invokeExportPrescriptionToPdf(idempotencyKey, CONFIG.org_id, { state: state, oils: oils, date: dateStr });
                };
            }

            function invokeExportPrescriptionToPdf(idempotencyKey, orgId, payload) {
                var btn = document.getElementById('btn-export-pdf');
                if (!btn) return;
                btn.disabled = true;
                btn.textContent = '導出中…';

                var requestBody = {
                    data: {
                        idempotency_key: idempotencyKey,
                        org_id: orgId,
                        prescription: payload
                    }
                };

                fetch(CONFIG.exportPdfUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                })
                    .then(function (response) { return response.json(); })
                    .then(function (res) {
                        var result = (res && res.result) ? res.result : res;
                        if (result && result.pdf_url) {
                            window.open(result.pdf_url, '_blank');
                            btn.textContent = '導出 PDF';
                            btn.disabled = false;
                        } else if (result && result.ack) {
                            btn.textContent = '已提交導出';
                        } else {
                            btn.textContent = '導出 PDF';
                            btn.disabled = false;
                        }
                    })
                    .catch(function () {
                        btn.textContent = '導出 PDF';
                        btn.disabled = false;
                    });
            }
        })();
    </script>
</body>
</html>
