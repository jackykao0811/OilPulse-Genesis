rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 使用者僅能讀寫自己的 document [cite: 2026-02-08, 2026-02-12]
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    // 追蹤連結：允許未登入讀取（/t/:id 重定向用）；寫入需登入且所屬 org
    match /tracking_links/{linkId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
    }
    // 多租戶數據隔離 (RLS)：僅所屬 org 成員可存取 [cite: 2026-02-08, 2026-02-12]
    match /orgs/{orgId}/{path=**} {
      allow read, write: if request.auth != null
        && get(/databases/$(database)/documents/orgs/$(orgId)/_meta/members).data[request.auth.uid] == true;
    }
  }
}
